import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { logger } from 'hono/logger'
import { serveStatic } from 'hono/cloudflare-workers'
import { renderer } from './renderer'
import type { Bindings } from './types'

// Import routes
import chat from './routes/chat'
import pages from './routes/pages'

const app = new Hono<{ Bindings: Bindings }>()

// Middleware
app.use('/api/*', cors())
app.use('*', logger())

// Serve static files
app.use('/static/*', serveStatic({ root: './public' }))

// API routes
app.route('/api/chat', chat)

// Page routes (before renderer)
app.route('', pages)

// Frontend routes
app.use(renderer)

// Home page - Chat Interface
app.get('/', (c) => {
  return c.render(
    <div class="container" style="padding-top: 2rem; padding-bottom: 2rem; max-width: 900px;">
      {/* Header */}
      <div style="text-align: center; margin-bottom: 2rem;">
        <img src="/static/unibase-logo.png" alt="è„³æ´»labo Unibase" style="height: 60px; margin-bottom: 0.5rem;" />
        <h1 style="font-size: 1.75rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--text-primary);">
          Neuro mate - AIãƒ˜ãƒ«ã‚¹ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼
        </h1>
        <p style="font-size: 0.95rem; color: var(--text-secondary);">
          è„³æ´»labo Unibase åº—èˆ—ä¼šå“¡å°‚ç”¨ã‚µãƒ¼ãƒ“ã‚¹
        </p>
      </div>

      {/* Chat Container */}
      <div class="card" style="padding: 0; overflow: hidden;">
        {/* Chat Messages */}
        <div id="chat-messages" style="height: 500px; overflow-y: auto; padding: 1.5rem; background: var(--bg-secondary);">
          <div class="chat-message ai-message">
            <div class="message-bubble" style="background: var(--bg-card); border: 1px solid var(--border-color); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
              <p style="margin-bottom: 0.5rem; color: var(--text-primary);">
                ã“ã‚“ã«ã¡ã¯ï¼è„³æ´»labo Unibaseã®<strong>Neuro mate</strong>ã§ã™ ğŸ§ âœ¨
              </p>
              <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">
                ã‚ãªãŸã®ç—‡çŠ¶ã‚„ç”Ÿæ´»ç¿’æ…£ã‹ã‚‰ã€æœ€é©ãªã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆã¨ã‚»ãƒ«ãƒ•ã‚±ã‚¢ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚
              </p>
              <p style="color: var(--primary-color); font-weight: bold; margin-top: 1rem;">
                ã¾ãšã€ä¼šå“¡IDï¼ˆä¾‹ï¼šUNI-001ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ ğŸ“
              </p>
            </div>
          </div>
        </div>

        {/* Input Area */}
        <div id="input-area" style="padding: 1rem; border-top: 1px solid var(--border-color); background: var(--bg-card);">
          <div id="member-id-input">
            <div style="display: flex; gap: 0.5rem;">
              <input 
                type="text" 
                id="member-id-field" 
                class="form-input" 
                placeholder="ä¼šå“¡IDï¼ˆä¾‹ï¼šUNI-001ï¼‰" 
                style="flex: 1;"
                maxlength="7"
              />
              <button onclick="verifyMemberId()" class="btn btn-primary">
                ç¢ºèª
              </button>
            </div>
            <div id="member-error" style="color: #e74c3c; margin-top: 0.5rem; font-size: 0.9rem;"></div>
          </div>

          <div id="consultation-input" style="display: none;">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">ç¾åœ¨ã®æ‚©ã¿ãƒ»ç—‡çŠ¶</label>
              <textarea id="concerns" class="form-input" rows="3" placeholder="ä¾‹ï¼šè‚©ã“ã‚Šã€é ­ç—›ã€ç¡çœ ã®è³ªãŒæ‚ªã„..." style="resize: vertical;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">ç”Ÿæ´»ãƒªã‚ºãƒ </label>
              <textarea id="lifestyle" class="form-input" rows="2" placeholder="ä¾‹ï¼šãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯8æ™‚é–“ã€ç¡çœ 6æ™‚é–“..." style="resize: vertical;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">ãã®ä»–è£œè¶³æƒ…å ±</label>
              <textarea id="notes" class="form-input" rows="2" placeholder="ä¾‹ï¼šã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã€æœç”¨ä¸­ã®è–¬..." style="resize: vertical;"></textarea>
            </div>
            <button onclick="submitConsultation()" class="btn btn-primary" style="width: 100%;">
              AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å—ã‘ã‚‹
            </button>
          </div>
        </div>
      </div>

      <script dangerouslySetInnerHTML={{ __html: `
        (function() {
          let currentMember = null;

          function addMessage(content, isAi = true) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isAi ? 'chat-message ai-message' : 'chat-message user-message';
            messageDiv.innerHTML = \`
              <div class="message-bubble" style="
                background: \${isAi ? 'var(--bg-card)' : 'var(--primary-color)'}; 
                border: 1px solid \${isAi ? 'var(--border-color)' : 'var(--primary-color)'}; 
                padding: 1rem; 
                border-radius: 12px; 
                margin-bottom: 1rem;
                \${!isAi ? 'margin-left: auto; max-width: 80%;' : ''}
              ">
                <p style="margin: 0; color: \${isAi ? 'var(--text-primary)' : '#fff'};">\${content}</p>
              </div>
            \`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }

          window.verifyMemberId = async function verifyMemberId() {
          const memberIdField = document.getElementById('member-id-field');
          const memberId = memberIdField.value.trim().toUpperCase();
          const errorDiv = document.getElementById('member-error');
          
          console.log('verifyMemberId called with:', memberId);
          
          if (!memberId) {
            errorDiv.textContent = 'ä¼šå“¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            return;
          }

          errorDiv.textContent = 'ç¢ºèªä¸­...';

          try {
            console.log('Fetching /api/chat/verify...');
            const response = await fetch('/api/chat/verify', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ member_id: memberId })
            });

            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);

            if (data.success) {
              currentMember = data.member;
              errorDiv.textContent = '';
              addMessage(\`ã‚ˆã†ã“ãã€\${data.member.name || 'ä¼šå“¡æ§˜'}ã•ã‚“ï¼ğŸ˜Š\`, true);
              addMessage(\`ãã‚Œã§ã¯ã€ã‚ãªãŸã®å¥åº·çŠ¶æ…‹ã«ã¤ã„ã¦ãŠèã‹ã›ãã ã•ã„ã€‚\`, true);
              
              document.getElementById('member-id-input').style.display = 'none';
              document.getElementById('consultation-input').style.display = 'block';
            } else {
              errorDiv.textContent = data.error;
            }
          } catch (error) {
            console.error('Error:', error);
            errorDiv.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
          }
        }

          window.submitConsultation = async function submitConsultation() {
            const concerns = document.getElementById('concerns').value;
            const lifestyle = document.getElementById('lifestyle').value;
            const notes = document.getElementById('notes').value;

            if (!concerns || !lifestyle) {
              alert('ç¾åœ¨ã®æ‚©ã¿ãƒ»ç—‡çŠ¶ã¨ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
              return;
            }

            addMessage(\`ã€ç›¸è«‡å†…å®¹ã€‘\\næ‚©ã¿: \${concerns}\\nç”Ÿæ´»: \${lifestyle}\${notes ? '\\nè£œè¶³: ' + notes : ''}\`, false);
            addMessage('åˆ†æä¸­ã§ã™...ãŠå¾…ã¡ãã ã•ã„ â³', true);

            try {
              const response = await fetch('/api/chat/consult', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  member_id: currentMember.member_id,
                  member_name: currentMember.name,
                  currentConcerns: concerns,
                  lifestyleRhythm: lifestyle,
                  additionalNotes: notes
                })
              });

              const data = await response.json();

              if (data.success) {
                const report = data.report;
                
                // Remove "åˆ†æä¸­..." message
                const messages = document.getElementById('chat-messages');
                messages.removeChild(messages.lastChild);

                // Display AI report
                addMessage(\`ğŸ“Š **ç·åˆåˆ†æçµæœ**\\n\\n\${report.summary}\`, true);
                
                if (report.supplements && report.supplements.length > 0) {
                  const supplementText = report.supplements.map(s => 
                    \`â€¢ **\${s.name}** (ã‚¹ã‚³ã‚¢: \${s.score}/100)\\n  \${s.reason}\`
                  ).join('\\n\\n');
                  addMessage(\`ğŸ’Š **ãŠã™ã™ã‚ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ**\\n\\n\${supplementText}\`, true);
                }

                if (report.selfCare && report.selfCare.length > 0) {
                  const selfCareText = report.selfCare.map(s => 
                    \`â€¢ **\${s.title}**\\n  \${s.description}\`
                  ).join('\\n\\n');
                  addMessage(\`ğŸ§˜ **ã‚»ãƒ«ãƒ•ã‚±ã‚¢ãƒ¡ãƒ‹ãƒ¥ãƒ¼**\\n\\n\${selfCareText}\`, true);
                }

                addMessage('ç›¸è«‡å†…å®¹ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ âœ…', true);
              } else {
                addMessage('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', true);
              }
            } catch (error) {
              addMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
            }
          };

          // Allow Enter key to submit member ID
          document.getElementById('member-id-field').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              window.verifyMemberId();
            }
          });
        })();
      ` }} />
    </div>
  )
})



export default app
